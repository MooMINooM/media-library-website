<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>คลังสื่อดิจิทัล</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">คลังสื่อดิจิทัล</h1>
            <p class="text-lg text-gray-600 mt-2">ศูนย์รวมสื่อการเรียนรู้สำหรับทุกคน</p>
        </header>

        <!-- Filters and Search -->
        <div class="bg-white p-4 rounded-xl shadow-md mb-8 sticky top-4 z-10">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-2">
                    <label for="search" class="block text-sm font-medium text-gray-700">ค้นหาชื่อสื่อ</label>
                    <input type="text" id="search" placeholder="เช่น ฟิสิกส์, คณิตศาสตร์..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <div>
                    <label for="subject-filter" class="block text-sm font-medium text-gray-700">วิชา</label>
                    <select id="subject-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        <option value="">ทั้งหมด</option>
                    </select>
                </div>
                <div>
                    <label for="grade-filter" class="block text-sm font-medium text-gray-700">ระดับชั้น</label>
                    <select id="grade-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        <option value="">ทั้งหมด</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Media Content -->
        <main id="media-content">
            <div id="loader" class="text-center py-10">
                <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-600">กำลังโหลดข้อมูลสื่อ...</p>
            </div>
            <div id="media-cards" class="card-container">
                <!-- Media cards will be inserted here by JavaScript -->
            </div>
            <div id="no-results" class="text-center py-10 hidden">
                 <p class="text-xl text-gray-500">ไม่พบสื่อที่ตรงกับเงื่อนไข</p>
            </div>
        </main>

    </div>

    <script>
        let allMedia = [];
        
        // =================================================================
        //  สำคัญมาก! แก้ไข URL ตรงนี้เป็น URL ของเว็บแอปที่คุณ Deploy ไว้ 
        // =================================================================
        const SCRIPT_URL = 'วาง URL ของเว็บแอปจาก Apps Script ที่นี่'; 
        // =================================================================


        // --- Event Listeners ---
        window.onload = () => {
            fetchData();
            document.getElementById('search').addEventListener('input', applyFilters);
            document.getElementById('subject-filter').addEventListener('change', applyFilters);
            document.getElementById('grade-filter').addEventListener('change', applyFilters);
        };
        
        // --- Data Fetching using fetch API ---
        async function fetchData() {
            if (!SCRIPT_URL || SCRIPT_URL === 'https://script.google.com/macros/s/AKfycbxgxfZ5SB9Um4HftajMJS6RJMG9kwd6hVjKz_DYTxDgQOB9qk1Xxl0mS1dr5YuoIFi-/exec') {
                 showError({ message: 'กรุณาตั้งค่า SCRIPT_URL ในไฟล์ index.html ก่อน' });
                 return;
            }
            
            document.getElementById('loader').style.display = 'block';

            try {
                // ดึงข้อมูลสื่อและข้อมูลตัวกรองพร้อมกัน
                const [mediaRes, filtersRes] = await Promise.all([
                    fetch(`${SCRIPT_URL}?action=getMediaData`),
                    fetch(`${SCRIPT_URL}?action=getFilters`)
                ]);

                if (!mediaRes.ok || !filtersRes.ok) {
                    throw new Error(`เกิดข้อผิดพลาดจากเซิร์ฟเวอร์: ${mediaRes.statusText}`);
                }

                const mediaData = await mediaRes.json();
                const filterData = await filtersRes.json();
                
                allMedia = mediaData;
                populateFilters(filterData);
                displayMedia(allMedia);

            } catch (error) {
                showError(error);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }


        function populateFilters(filters) {
            const subjectSelect = document.getElementById('subject-filter');
            const gradeSelect = document.getElementById('grade-filter');
            
            filters.subjects.forEach(subject => {
                const option = new Option(subject, subject);
                subjectSelect.add(option);
            });
            
            filters.grades.forEach(grade => {
                const option = new Option(grade, grade);
                gradeSelect.add(option);
            });
        }

        // --- Display Logic ---
        function displayMedia(mediaList) {
            const container = document.getElementById('media-cards');
            const noResults = document.getElementById('no-results');
            container.innerHTML = '';

            if (mediaList.length === 0) {
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
            }

            mediaList.forEach(media => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition-transform duration-300';
                
                const coverImage = media['รูปปกสื่อ'] || 'https://placehold.co/600x400/e2e8f0/64748b?text=ไม่มีรูปภาพ';
                const subject = media['ประเภทสื่อ (วิชา)'] || 'ไม่ระบุ';
                const grade = media['ระดับชั้น'] || 'ไม่ระบุ';
                const createdDate = new Date(media['วันที่อัปโหลด']).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });

                card.innerHTML = `
                    <img src="${coverImage}" alt="${media['ชื่อสื่อ']}" class="w-full h-48 object-cover">
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-2">
                           <div class="flex flex-wrap gap-2">
                                <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-indigo-600 bg-indigo-200">${subject}</span>
                                <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-green-600 bg-green-200">${grade}</span>
                           </div>
                        </div>
                        <h3 class="text-xl font-bold mb-2 truncate" title="${media['ชื่อสื่อ']}">${media['ชื่อสื่อ']}</h3>
                        <p class="text-gray-600 text-sm mb-3 h-10 overflow-hidden">${media['คำอธิบาย'] || 'ไม่มีคำอธิบาย'}</p>
                        <p class="text-xs text-gray-500 mb-4">สร้างโดย: ${media['ผู้สร้าง'] || 'ไม่ระบุ'} | อัปโหลด: ${createdDate}</p>
                        <a href="${media['ลิงก์ดูไฟล์']}" target="_blank" class="block w-full text-center bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                            เปิดสื่อ
                        </a>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // --- Filtering Logic ---
        function applyFilters() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const selectedSubject = document.getElementById('subject-filter').value;
            const selectedGrade = document.getElementById('grade-filter').value;

            const filteredMedia = allMedia.filter(media => {
                const nameMatch = media['ชื่อสื่อ'].toLowerCase().includes(searchTerm);
                const subjectMatch = !selectedSubject || media['ประเภทสื่อ (วิชา)'] === selectedSubject;
                const gradeMatch = !selectedGrade || media['ระดับชั้น'] === selectedGrade;
                
                return nameMatch && subjectMatch && gradeMatch;
            });
            
            displayMedia(filteredMedia);
        }

        function showError(error) {
            console.error('Error:', error);
            const loader = document.getElementById('loader');
            loader.style.display = 'block';
            loader.innerHTML = `<p class="text-red-500 font-bold">เกิดข้อผิดพลาด: ${error.message}</p><p class="text-sm text-gray-600 mt-2">โปรดตรวจสอบว่าคุณได้ใส่ URL ของเว็บแอปถูกต้องแล้ว และได้ Deploy สคริปต์เวอร์ชันล่าสุดแล้ว</p>`;
        }

    </script>

</body>
</html>
